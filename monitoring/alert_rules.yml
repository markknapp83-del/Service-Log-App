# Healthcare Service Log Portal - Prometheus Alert Rules
# Critical alerts for healthcare system monitoring

groups:
  # Application Health Alerts
  - name: healthcare.application
    rules:
      - alert: HealthcarePortalDown
        expr: up{job="healthcare-portal"} == 0
        for: 1m
        labels:
          severity: critical
          service: healthcare-portal
        annotations:
          summary: "Healthcare Portal is down"
          description: "Healthcare Portal has been down for more than 1 minute"
          
      - alert: HealthcarePortalHighErrorRate
        expr: rate(http_requests_total{status=~"5.."}[5m]) > 0.1
        for: 2m
        labels:
          severity: warning
          service: healthcare-portal
        annotations:
          summary: "High error rate detected"
          description: "Error rate is {{ $value }} errors per second"
          
      - alert: HealthcarePortalSlowResponse
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 2
        for: 5m
        labels:
          severity: warning
          service: healthcare-portal
        annotations:
          summary: "Slow response times detected"
          description: "95th percentile response time is {{ $value }}s"

  # Database Alerts
  - name: healthcare.database
    rules:
      - alert: DatabaseConnectionError
        expr: healthcare_database_connected == 0
        for: 30s
        labels:
          severity: critical
          service: database
        annotations:
          summary: "Database connection lost"
          description: "Unable to connect to healthcare database"
          
      - alert: DatabaseSlowQueries
        expr: healthcare_database_slow_queries_total > 10
        for: 5m
        labels:
          severity: warning
          service: database
        annotations:
          summary: "High number of slow database queries"
          description: "{{ $value }} slow queries detected in the last 5 minutes"
          
      - alert: DatabaseDiskSpaceLow
        expr: healthcare_database_disk_usage_percent > 85
        for: 5m
        labels:
          severity: warning
          service: database
        annotations:
          summary: "Database disk space running low"
          description: "Database disk usage is {{ $value }}%"

  # HIPAA Compliance Alerts
  - name: healthcare.hipaa
    rules:
      - alert: UnauthorizedAccessAttempt
        expr: increase(healthcare_auth_failed_attempts_total[5m]) > 5
        for: 1m
        labels:
          severity: critical
          service: security
        annotations:
          summary: "Multiple failed authentication attempts"
          description: "{{ $value }} failed authentication attempts in the last 5 minutes"
          
      - alert: AuditLogFailure
        expr: healthcare_audit_log_errors_total > 0
        for: 1m
        labels:
          severity: critical
          service: audit
        annotations:
          summary: "Audit logging failure"
          description: "Audit log errors detected - HIPAA compliance at risk"
          
      - alert: PHIAccessViolation
        expr: healthcare_phi_access_violations_total > 0
        for: 0s
        labels:
          severity: critical
          service: security
        annotations:
          summary: "PHI access violation detected"
          description: "Unauthorized attempt to access protected health information"

  # Security Alerts
  - name: healthcare.security
    rules:
      - alert: RateLimitExceeded
        expr: increase(healthcare_rate_limit_exceeded_total[1m]) > 100
        for: 2m
        labels:
          severity: warning
          service: security
        annotations:
          summary: "High rate limiting activity"
          description: "{{ $value }} rate limit violations in the last minute"
          
      - alert: SuspiciousActivity
        expr: healthcare_security_events_total{type="suspicious"} > 0
        for: 0s
        labels:
          severity: critical
          service: security
        annotations:
          summary: "Suspicious activity detected"
          description: "Security monitoring has detected suspicious activity"
          
      - alert: SSLCertificateExpiring
        expr: ssl_certificate_expiry_days < 30
        for: 1h
        labels:
          severity: warning
          service: security
        annotations:
          summary: "SSL certificate expiring soon"
          description: "SSL certificate expires in {{ $value }} days"

  # Performance Alerts
  - name: healthcare.performance
    rules:
      - alert: HighCPUUsage
        expr: healthcare_cpu_usage_percent > 80
        for: 5m
        labels:
          severity: warning
          service: performance
        annotations:
          summary: "High CPU usage"
          description: "CPU usage is {{ $value }}% for more than 5 minutes"
          
      - alert: HighMemoryUsage
        expr: healthcare_memory_usage_percent > 85
        for: 5m
        labels:
          severity: warning
          service: performance
        annotations:
          summary: "High memory usage"
          description: "Memory usage is {{ $value }}% for more than 5 minutes"
          
      - alert: LowDiskSpace
        expr: healthcare_disk_free_percent < 10
        for: 5m
        labels:
          severity: critical
          service: performance
        annotations:
          summary: "Low disk space"
          description: "Only {{ $value }}% disk space remaining"

  # Backup and Recovery Alerts
  - name: healthcare.backup
    rules:
      - alert: BackupFailed
        expr: time() - healthcare_last_successful_backup_timestamp > 86400
        for: 1h
        labels:
          severity: critical
          service: backup
        annotations:
          summary: "Database backup failed"
          description: "No successful backup in the last 24 hours"
          
      - alert: BackupSize
        expr: healthcare_backup_size_bytes < 1000000
        for: 1h
        labels:
          severity: warning
          service: backup
        annotations:
          summary: "Backup size is unusually small"
          description: "Backup size is {{ $value | humanize }} bytes"

  # Business Logic Alerts
  - name: healthcare.business
    rules:
      - alert: HighServiceLogSubmissions
        expr: increase(healthcare_service_logs_created_total[1h]) > 1000
        for: 15m
        labels:
          severity: info
          service: business
        annotations:
          summary: "High service log submission rate"
          description: "{{ $value }} service logs created in the last hour"
          
      - alert: NoServiceLogSubmissions
        expr: increase(healthcare_service_logs_created_total[4h]) == 0
        for: 30m
        labels:
          severity: warning
          service: business
        annotations:
          summary: "No service log submissions"
          description: "No service logs have been created in the last 4 hours"